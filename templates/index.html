<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OBS Sync and Recording Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <!-- Include Socket.IO client -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
    <h1>OBS Recording Dashboard</h1>
    <h2>Some important considerations:</h2>
    <p>
        Make sure all devices are on the same network.<br>
        Do not close the terminal window used to start this dashboard.<br>
        If a device does not connect, remove and re-enter its details.
    </p>

    <!-- Start/Stop Recording Buttons -->
    <h2>Control Recording</h2>
    <button id="start-recording-btn">Start Recording</button>
    <button id="stop-recording-btn">Stop Recording</button>

    <!-- New section to set REAPER configuration -->
    <h2>Set REAPER Configuration</h2>
    <form id="set-reaper-config-form">
        <input type="text" id="reaper-ip" placeholder="REAPER IP Address" required>
        <input type="number" id="reaper-port" placeholder="REAPER Port" required>
        <button type="submit">Set REAPER Config</button>
    </form>

    <h2>Add OBS Instance</h2>
    <form id="add-device-form">
        <input type="text" id="name" placeholder="Device Name">
        <input type="text" id="ip" placeholder="IP Address" required>
        <input type="number" id="port" placeholder="Port" required>
        <input type="password" id="password" placeholder="Password">
        <button type="submit">Add Device</button>
    </form>

    <h2>Devices</h2>
    <button id="connect-instances-btn">Connect to All OBS Instances</button>
    <table class="device-table">
        <thead>
            <tr>
                <th>Device Name</th>
                <th>Device IP</th>
                <th>Port</th>
                <th>Connection Status</th>
                <th>Recording Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="device-list">
            <!-- Devices will be dynamically populated -->
        </tbody>
    </table>

    <div id="log">
        <!-- Log messages will appear here -->
    </div>

    <script>
        var socket = io();

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });

        // Fetch initial devices
        fetch('/get_devices')
            .then(response => response.json())
            .then(data => {
                console.log('Received devices:', data);
                data.forEach(device => {
                    addDeviceRow(device);
                });
            })
            .catch(error => {
                console.error('Error fetching devices:', error);
            });

        // Fetch current REAPER configuration on page load
        fetch('/get_reaper_config')
            .then(response => response.json())
            .then(data => {
                document.getElementById('reaper-ip').value = data.reaper_ip || '';
                document.getElementById('reaper-port').value = data.reaper_port || '';
            })
            .catch(error => {
                console.error('Error fetching REAPER configuration:', error);
            });

        // Handle device status updates
        socket.on('device_status', function(data) {
            console.log('Received device_status:', data);
            updateDeviceRow(data);
        });

        // Handle log messages
        socket.on('log', function(data) {
            console.log('Received log:', data);
            var logDiv = document.getElementById('log');
            var p = document.createElement('p');
            p.textContent = data.message;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        });

        // Add device form submission
        document.getElementById('add-device-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var name = document.getElementById('name').value;
            var ip = document.getElementById('ip').value;
            var port = document.getElementById('port').value;
            var password = document.getElementById('password').value;

            fetch('/add_device', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({'ip': ip, 'port': port, 'password': password, 'name': name})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Device added successfully');
                    // Clear form fields
                    document.getElementById('name').value = '';
                    document.getElementById('ip').value = '';
                    document.getElementById('port').value = '';
                    document.getElementById('password').value = '';
                } else {
                    console.error('Error adding device:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error adding device:', error);
                alert('An error occurred while adding the device.');
            });
        });

        // Handle REAPER configuration form submission
        document.getElementById('set-reaper-config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var reaperIp = document.getElementById('reaper-ip').value;
            var reaperPort = document.getElementById('reaper-port').value;

            fetch('/set_reaper_config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({'reaper_ip': reaperIp, 'reaper_port': reaperPort})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('REAPER configuration updated successfully');
                    alert('REAPER configuration set successfully to ' + reaperIp + ':' + reaperPort);
                } else {
                    console.error('Error setting REAPER configuration:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error setting REAPER configuration:', error);
                alert('An error occurred while setting the REAPER configuration.');
            });
        });

        // Connect to All OBS Instances button
        document.getElementById('connect-instances-btn').addEventListener('click', function() {
            fetch('/connect_obs_instances', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Connection attempt initiated');
                    // Optionally, provide feedback to the user
                } else {
                    console.error('Error initiating connection:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error initiating connection:', error);
                alert('An error occurred while attempting to connect to OBS instances.');
            });
        });

        // Start Recording button
        document.getElementById('start-recording-btn').addEventListener('click', function() {
            fetch('/start_recording', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Recording start initiated');
                    alert('Recording will start shortly.');
                } else {
                    console.error('Error starting recording:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error starting recording:', error);
                alert('An error occurred while starting recording.');
            });
        });

        // Stop Recording button
        document.getElementById('stop-recording-btn').addEventListener('click', function() {
            fetch('/stop_recording', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Recording stop initiated');
                    alert('Recording has been stopped.');
                } else {
                    console.error('Error stopping recording:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error stopping recording:', error);
                alert('An error occurred while stopping recording.');
            });
        });

        // Add device row to table
        function addDeviceRow(device) {
            var tbody = document.getElementById('device-list');
            var rowId = device.ip + ':' + device.port;
            var existingRow = document.getElementById(rowId);
            if (existingRow) {
                return; // Row already exists
            }
            var row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = getDeviceRowHtml(device);
            tbody.appendChild(row);
        }

        // Update device row
        function updateDeviceRow(data) {
            var rowId = data.ip + ':' + data.port;
            var row = document.getElementById(rowId);

            if (!row) {
                // Add new row if it doesn't exist
                addDeviceRow(data);
            } else {
                // Update existing row
                row.innerHTML = getDeviceRowHtml(data);
            }
        }

        // Generate HTML for a device row
        function getDeviceRowHtml(device) {
            // Determine the action button based on connection status
            var actionButton = '';
            if (device.status === 'Connected') {
                actionButton = `<button onclick="disconnectDevice('${device.ip}', '${device.port}')">Disconnect</button>`;
            } else {
                actionButton = `<button onclick="connectDevice('${device.ip}', '${device.port}')">Connect</button>`;
            }
            // Add the Remove button
            actionButton += ` <button onclick="removeDevice('${device.ip}', '${device.port}')">Remove</button>`;

            return `
                <td>${device.name || ''}</td>
                <td>${device.ip}</td>
                <td>${device.port}</td>
                <td class="status-${device.status.toLowerCase()}">${device.status}</td>
                <td class="recording-status ${device.recording ? 'recording-yes' : 'recording-no'}">${device.recording ? 'Recording' : 'Not Recording'}</td>
                <td>${actionButton}</td>
            `;
        }

        // Connect to a single device
        function connectDevice(ip, port) {
            fetch('/connect_device', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({'ip': ip, 'port': port})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Connection attempt to ${ip}:${port} initiated`);
                    // Optionally, provide feedback to the user
                } else {
                    console.error(`Error connecting to ${ip}:${port}:`, data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error(`Error connecting to ${ip}:${port}:`, error);
                alert('An error occurred while attempting to connect to the device.');
            });
        }

        // Disconnect from a single device
        function disconnectDevice(ip, port) {
            fetch('/disconnect_device', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({'ip': ip, 'port': port})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Disconnected from ${ip}:${port}`);
                    // Optionally, provide feedback to the user
                } else {
                    console.error(`Error disconnecting from ${ip}:${port}:`, data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error(`Error disconnecting from ${ip}:${port}:`, error);
                alert('An error occurred while attempting to disconnect from the device.');
            });
        }

        // Remove device
        function removeDevice(ip, port) {
            if (confirm(`Are you sure you want to remove device ${ip}:${port}?`)) {
                fetch('/remove_device', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({'ip': ip, 'port': port})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Device removed successfully');
                        // Remove row from table
                        var rowId = ip + ':' + port;
                        var row = document.getElementById(rowId);
                        if (row) {
                            row.parentNode.removeChild(row);
                        }
                    } else {
                        console.error('Error removing device:', data.message);
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing device:', error);
                    alert('An error occurred while removing the device.');
                });
            }
        }
    </script>
</body>
</html>
